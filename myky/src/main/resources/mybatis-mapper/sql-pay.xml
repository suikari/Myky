<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="teamgyodong.myky.pay.mapper.PayMapper">

	<insert id="insertPayment" parameterType="hashmap"  useGeneratedKeys="true" keyColumn="ORDER_ID" keyProperty="orderId">
		
		insert into payment
		<if test="option != 'donation'">
		values (payment_seq.nextval,#{paymentCode},#{description},#{amount},#{paymentMethod},#{installment},#{subscriptionPeriod},sysdate,#{paymentStatus},#{isCanceled},#{cancelDate},ORDERS_SEQ.NEXTVAL,#{donationId},#{userId})		
		</if>
		<if test="option == 'donation'">
		values (payment_seq.nextval,#{paymentCode},#{description},#{amount},#{paymentMethod},#{installment},#{subscriptionPeriod},sysdate,#{paymentStatus},#{isCanceled},#{cancelDate},null,#{donationId},#{userId})			
		</if>
		
	</insert>


	 <select id="selectPayment" parameterType="hashmap" resultType="teamgyodong.myky.pay.model.pay">
	 	
	 	SELECT *
		FROM PAYMENT P
		LEFT JOIN PRODUCT PD ON P.PRODUCT_ID = PD.PRODUCT_ID	
		LEFT JOIN USERS U ON P.USER_ID = U.USER_ID	

	 </select>
	 
	 <select id="selectCurrentPoint" parameterType="hashmap" resultType="teamgyodong.myky.pay.model.pay">
	 	
	 	select coalesce(
		    (select current_point
		     from point
		     where user_id = #{userId}
		     order by usage_date desc
		     fetch first 1 rows only), 0) as current_point
		from dual

	 </select>
	 
	 <insert id="insertUsedPoint" parameterType="hashmap">
	 
	 	insert into point
	 	values (point_seq.nextval, sysdate, #{usedPoint}, (select coalesce(max(current_point), 0) #{usedPoint} from point where user_id = #{userId}), #{remarks}, #{userId})
	 
	 </insert>
	 
</mapper>
