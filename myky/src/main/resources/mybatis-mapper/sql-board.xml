<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="teamgyodong.myky.board.mapper.BoardMapper">
	
	
	<select id="selectBoardList" parameterType="hashmap" resultType="teamgyodong.myky.board.model.board">
		SELECT 
		    F.*, TO_CHAR(F.UPDATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS updatedTime ,
		    (SELECT COUNT(*)
		    FROM FREE_BOARD_COMMENT C
		    WHERE C.BOARD_ID = F.BOARD_ID) AS COMMENT_COUNT
		FROM 
		    FREE_BOARD F
		WHERE 
		    1=1
		    <if test="searchOption != null and searchOption == 'all'">
		        AND (F.TITLE LIKE '%' || #{keyword} || '%' OR F.USER_ID LIKE '%' || #{keyword} || '%')
		    </if>
		    <if test="searchOption != null and searchOption == 'title'">
		        AND F.TITLE LIKE '%' || #{keyword} || '%'
		    </if>
		    <if test="searchOption != null and searchOption == 'userId'">
		        AND F.USER_ID LIKE '%' || #{keyword} || '%'
		    </if>
		    AND CATEGORY= #{category}
		    AND IS_DELETED = 'N'
		ORDER BY 
		    F.BOARD_ID DESC
		OFFSET #{page} ROWS FETCH NEXT #{pageSize} ROWS ONLY
	</select>
	
	<select id="selectBoardCnt" parameterType="hashmap" resultType="int">
		SELECT COUNT(*)
		FROM FREE_BOARD
		WHERE 1=1
		<choose>
			<when test="searchOption == 'title' and keyword != null and keyword != ''">
				AND TITLE LIKE '%' || #{keyword} || '%'
			</when>
			<when test="searchOption == 'userId' and keyword != null and keyword != ''">
				AND USER_ID LIKE '%' || #{keyword} || '%'
			</when>
			<when test="searchOption == 'all' and keyword != null and keyword != ''">
				AND (TITLE LIKE '%' || #{keyword} || '%' OR USER_ID LIKE '%' || #{keyword} || '%')
			</when>
		</choose>
			AND CATEGORY= #{category}
		    AND IS_DELETED = 'N'
	</select>
	
	<select id="selectCmtList" parameterType="hashmap" resultType="teamgyodong.myky.board.model.comment">
		SELECT F.*, TO_CHAR(UPDATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS updatedTime
		FROM FREE_BOARD_COMMENT F
		WHERE BOARD_ID = #{boardId} AND NVL(PARENT_COMMENT_ID,0) = 0 ORDER BY comment_id ASC
	</select>
	<select id="selectParentCmtList" parameterType="hashmap" resultType="teamgyodong.myky.board.model.comment">
		SELECT F.*, TO_CHAR(UPDATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS updatedTime
		FROM FREE_BOARD_COMMENT F
		WHERE BOARD_ID = #{boardId} AND parent_comment_id = #{parentId} ORDER BY comment_id ASC
	</select>
	
	<update id="updateCnt" parameterType="hashmap">
		UPDATE FREE_BOARD
		SET
			CNT = CNT + 1
		WHERE BOARD_ID = #{boardId}
	</update>
	
	<select id="selectBoard" parameterType="hashmap" resultType="teamgyodong.myky.board.model.board">
		SELECT F.*, TO_CHAR(CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') AS updatedTime
		FROM FREE_BOARD F
		WHERE BOARD_ID = #{boardId}
		AND CATEGORY= #{category}
	</select>
	
	<insert id="insertBoard" parameterType="hashmap" useGeneratedKeys="true" keyColumn="BOARD_ID" keyProperty="boardId">
		INSERT INTO FREE_BOARD(BOARD_ID, TITLE, CONTENT, CREATED_AT, UPDATED_AT, USER_ID, CATEGORY, CNT)
		VALUES(FREE_BOARD_SEQ.NEXTVAL, #{title}, #{content}, SYSDATE, SYSDATE, #{userId},  #{category}, 0)
	</insert>
	
	<update id="updateBoard" parameterType="hashmap">
		UPDATE FREE_BOARD
    	SET
        TITLE = #{title},
        CONTENT = #{content},
        UPDATED_AT = SYSDATE
		WHERE BOARD_ID = #{boardId}
	</update>
	
	<update id="updateRemoveBoard" parameterType="hashmap">
		UPDATE FREE_BOARD
		SET
		IS_DELETED = 'Y',
		UPDATED_AT = SYSDATE
		WHERE BOARD_ID = #{boardId}
	</update>
	
	<insert id="insertComment" parameterType="hashmap">
		INSERT INTO FREE_BOARD_COMMENT (COMMENT_ID, BOARD_ID, USER_ID, CONTENT, CREATED_AT, UPDATED_AT, IS_DELETED)
		VALUES(FREE_BOARD_COMMENT_SEQ.NEXTVAL, #{boardId}, #{userId}, #{content}, SYSDATE, SYSDATE, 'N')
	</insert>
		
	<update id="commentUpdate" parameterType="hashmap">
		UPDATE FREE_BOARD_COMMENT
    	SET
        CONTENT = #{content},
        UPDATED_AT = SYSDATE
		WHERE COMMENT_ID = #{commentId}
	</update>
	
	<delete id="deleteComment" parameterType="hashmap">
		DELETE FROM FREE_BOARD_COMMENT
		WHERE COMMENT_ID = #{commentId}
	</delete>
	
	<insert id="insertBoardFile" parameterType="hashmap">
		INSERT INTO FREE_BOARD_FILE
		VALUES(FREE_BOARD_FILE_SEQ.NEXTVAL, #{boardId}, #{fileName}, #{filePath}, #{originalName}, #{fileExt}, SYSDATE, #{fileSize})
	</insert>
	
	<select id="selectBoardImg" parameterType="hashmap" resultType="teamgyodong.myky.board.model.boardFile">
		SELECT * 
		FROM FREE_BOARD_FILE F
		LEFT JOIN FREE_BOARD B ON F.BOARD_ID = B.BOARD_ID
		WHERE F.BOARD_ID = #{boardId}
	</select>
	
	<delete id="deleteFile" parameterType="hashmap">
		DELETE FROM FREE_BOARD_FILE
		WHERE FILE_ID = #{fileId}
	</delete>

	<insert id="insertReply" parameterType="hashmap">
		INSERT INTO FREE_BOARD_COMMENT
		VALUES(FREE_BOARD_COMMENT_SEQ.NEXTVAL, #{boardId}, #{userId}, #{parentCommentId}, #{content}, SYSDATE, SYSDATE, 'N')
	</insert>
	
	<!-- Like Button-->
	<select id="selectLike" parameterType="hashmap" resultType="teamgyodong.myky.board.model.boardLikeLog" >
		SELECT *
		FROM FREE_BOARD_LIKE_LOG
		WHERE USER_ID = #{userId}
		  AND BOARD_ID = #{boardId}
	</select>
	
	<insert id="insertLikelog" parameterType="hashmap" >
		INSERT INTO FREE_BOARD_LIKE_LOG(BOARD_ID, USER_ID, STATUS)
		VALUES(#{boardId}, #{userId}, #{status})
	</insert>
	
	<delete id="deleteStatus" parameterType="hashmap">
		DELETE FROM FREE_BOARD_LIKE_LOG
		WHERE USER_ID = #{userId} AND BOARD_ID = #{boardId}
	</delete>
	
	<update id="updatelikeCntBoard" parameterType="hashmap">
		UPDATE FREE_BOARD
		SET
		    <if test="status != null and status == 'like'">
						LIKES = LIKES + #{finalstatus}
		    </if>
		    <if test="status != null and status == 'dislike'">
						DISLIKES = DISLIKES + #{finalstatus}
		    </if>		    
		WHERE BOARD_ID = #{boardId}
	</update>
</mapper>



