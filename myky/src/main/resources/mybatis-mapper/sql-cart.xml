<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="teamgyodong.myky.cart.mapper.CartMapper">
	
	
	<select id="selectCartList" parameterType="hashmap" resultType="teamgyodong.myky.cart.model.cart">
		
		select c.cart_id, c.user_id, c.session_id, c.created_at, ci.cart_item_id, ci.product_id, p.product_name, p.price, p.shipping_fee, p.shipping_free_minimum, ci.quantity, p.filepath
		from cart c
		join cart_item ci on c.cart_id = ci.cart_id
		join (
			select p.*, f.filepath
		    from product p  
		    left join product_file f on p.product_id = f.product_id and f.thumbnail = 'Y'
		) p on ci.product_id = p.product_id
		where c.user_id = #{userId}
			
	</select>
	
	<update id="updateCartQuantity" parameterType="hashmap">
	
		update cart_item
		set
			quantity = quantity + #{quantity}
		where cart_id = #{cartId} and product_id = #{productId}
	
	</update>
	
	<update id="updateQuantity" parameterType="hashmap">
	
		update cart_item
		set
			quantity = #{quantity}
		where cart_id = #{cartId} and product_id = #{productId}
	
	</update>
	
	<delete id="deleteCartProduct" parameterType="hashmap">
	
		delete cart_item
		where  cart_item_id = #{cartItemId}
	
	</delete>

	<delete id="deleteCart" parameterType="hashmap">
	
		delete cart
		where  cart_id = #{cartId}
	
	</delete>

	<delete id="deleteCartItem" parameterType="hashmap">
	
		delete cart_item
		where  cart_id = #{cartId}
	
	</delete>
	
	<insert id="insertCartProduct" parameterType="hashmap">
	
		insert into cart_item
		values (cart_item_seq.nextval, #{quantity}, #{cartId}, #{productId})
	
	</insert>
	
	<insert id="insertCart" parameterType="hashmap" useGeneratedKeys="true" keyColumn="cart_id" keyProperty="cartId">
	
		insert into cart
		values (cart_seq.nextval, sysdate, #{sessionId}, #{userId})
	
	</insert>

	<insert id="insertCartOrder" parameterType="hashmap" useGeneratedKeys="true" keyColumn="order_id" keyProperty="orderId">
	
		insert into orders (order_id, total_price, ordered_at, user_id, receiver_name, receiver_phone, receiver_addr, payment_method, delivery_message , UPDATED_AT)
		values (#{orderId}, #{totalPrice}, sysdate, #{userId}, #{receiverName}, #{receiverPhone}, #{receiverAddr}, #{paymentMethod}, #{deliveryMessage}, SYSDATE)
	
	</insert>

	<insert id="insertCartOrderDetail" parameterType="hashmap">
		INSERT ALL 
		
		<foreach collection="orderDetails" item="order" separator=" " >
		into order_details (order_detail_id, product_id, quantity, price, order_id)
		values
	        (
				order_details_seq.nextval,
				#{order.productId},
	            #{order.quantity},
	            #{order.price},
	            #{orderId}
	        )
    	</foreach>
    	
    	SELECT * FROM DUAL	
	</insert>
	
	<select id="findCart" parameterType="hashmap" resultType="teamgyodong.myky.cart.model.cart">
	   
	    select cart_id from cart where user_id = #{userId}
	
	</select>
	
	<select id="findCartItem" parameterType="hashmap" resultType="teamgyodong.myky.cart.model.cart">
	
		select c.cart_id, c.user_id, c.session_id, c.created_at, ci.cart_item_id, ci.product_id, p.product_name, p.price, ci.quantity
		from cart c
		join cart_item ci on c.cart_id = ci.cart_id
		join product p on ci.product_id = p.product_id
		where c.cart_id = #{cartId} and ci.product_id = #{productId}
	
	</select>
	
</mapper>




