<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î©çÎÉ•ÍΩÅÎÉ• Ï£ºÎ¨∏/Î∞∞ÏÜ°Ï°∞Ìöå</title>
	<!-- <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script> -->    
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8.4.7/swiper-bundle.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="/css/cart/cart.css" />
    
    <style>
    
    </style>
</head>
<body>
	<jsp:include page="/WEB-INF/common/header.jsp"/>
 


    <div id="app" class="order-body">
        <div class="order-container">
            <h2>Ï£ºÎ¨∏/Î∞∞ÏÜ°Ï°∞Ìöå</h2>
            <div class="order-history">
                <!-- Ï£ºÎ¨∏ Ï°∞Ìöå ÌïÑÌÑ∞ -->
                <div class="order-history__filter">
                    <button @click="setDateRange(1)" class="order-history__button">ÏµúÍ∑º 1Í∞úÏõî</button>
                    <button @click="setDateRange(3)" class="order-history__button">ÏµúÍ∑º 3Í∞úÏõî</button>
                    <button @click="setDateRange(6)" class="order-history__button">ÏµúÍ∑º 6Í∞úÏõî</button>
                    <input type="date" v-model="startDate" class="order-history__input">
                    <span>~</span>
                    <input type="date" v-model="endDate" class="order-history__input">
                    <button @click="fnOrderList" class="order-history__button">Ï°∞Ìöå</button>
                    <select v-model="selectedStatus" @change="fnOrderList" class="order-history__select">
                        <option value="all">Ï†ÑÏ≤¥</option>
                        <option value="paid">Ï£ºÎ¨∏Ï†ëÏàò</option>
                        <option value="shipped">Î∞∞ÏÜ°Ï§ë</option>
                        <option value="delivered">Î∞∞ÏÜ°ÏôÑÎ£å</option>
                        <option value="exchange_return">ÍµêÌôò/Î∞òÌíà</option>
                        <option value="canceled">Ï£ºÎ¨∏Ï∑®ÏÜå</option>
                    </select>
                </div>
                
                <!-- Ï£ºÎ¨∏ ÎÇ¥Ïó≠ ÌÖåÏù¥Î∏î -->
                <div v-if="isEmptyOrderList" class="empty-order">
                    <div class="empty-order__emoji">üì¶</div>
                    <p class="empty-order__text">Ï£ºÎ¨∏ÌïòÏã† ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                    <a href="/product/list.do" class="empty-order__link">ÏÉÅÌíà ÎëòÎü¨Î≥¥Í∏∞</a>
                </div>
                <div v-for="(ordersByOrderId, date) in groupedOrders" :key="date">
                    <div class="order-date">{{ date }}</div>
                    <div v-for="(orders, orderId) in ordersByOrderId" :key="orderId" :id="'order-' + orderId">
                        <div class="order-id">Ï£ºÎ¨∏Î≤àÌò∏: {{ orderId }}</div>
                        <table class="order-history__table">
                            <thead>
                                <tr>
                                    <th>ÏàòÎ†πÏù∏</th>
                                    <th>ÏÉÅÌíà</th>
                                    <th>Í∏àÏï°</th>
                                    <th>ÏÉÅÌÉú</th>
                                    <th>ÏÉÅÏÑ∏Î≥¥Í∏∞</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ orders[0].receiverName }}</td>
                                    <td>
                                        {{ orders[0].productName }} 
                                        <span v-if="orders.length > 1"> Ïô∏ {{ orders.length - 1 }}Í∞ú</span>
                                    </td>
                                    <td>{{ formatPrice(Number(orders[0].totalPrice)) }} Ïõê</td>
                                    <td>{{ determineShippingStatus(orders) }}</td>
                                    <td>
                                        <button class="order-history__details-button" @click="toggleDetails(orderId)">
                                            {{ ordersByDate[date][orderId][0].showDetails ? 'Ïà®Í∏∞Í∏∞' : 'Î∞∞ÏÜ°Ï†ïÎ≥¥' }}
                                        </button>
                                    </td>
                                </tr>
                                <tr v-if="ordersByDate[date][orderId][0].showDetails">
                                    <td colspan="5">
                                        <div class="order-history__details">
                                            <div v-if="!isEditing">
                                                <p><strong>ÏàòÎ†πÏù∏:</strong> {{ orders[0].receiverName }}</p>
                                                <p><strong>Ïó∞ÎùΩÏ≤ò:</strong> {{ formatPhoneNumber(orders[0].receiverPhone) }}</p>
                                                <p><strong>Î∞∞ÏÜ°ÏßÄ:</strong> {{ orders[0].receiverAddr }}</p>
                                                <p><strong>Î∞∞ÏÜ°Î©îÏãúÏßÄ:</strong> {{ orders[0].deliveryMessage || 'ÏóÜÏùå' }}</p>
                                                <hr>
                                            </div>
                                            <div v-else class="order-edit-form">
                                                <label>ÏàòÎ†πÏù∏: 
                                                  <input type="text" class="order-input" v-model="orderInfo.receiver" required>
                                                </label><br>
                                          
                                                <label>Ïö∞Ìé∏Î≤àÌò∏:
                                                  <input type="text" class="order-input short" v-model="orderInfo.zipcode"
                                                    placeholder="Ïö∞Ìé∏Î≤àÌò∏" readonly>
                                                  <button type="button" @click="searchAddress">Ïö∞Ìé∏Î≤àÌò∏ Í≤ÄÏÉâ</button>
                                                </label><br>
                                          
                                                <label>Í∏∞Î≥∏ Ï£ºÏÜå:
                                                  <input type="text" class="order-input" v-model="orderInfo.baseAddress" placeholder="Í∏∞Î≥∏ Ï£ºÏÜå" readonly>
                                                </label><br>
                                          
                                                <label>ÏÉÅÏÑ∏ Ï£ºÏÜå:
                                                  <input type="text" class="order-input" v-model="orderInfo.detailAddress"
                                                    placeholder="ÏÉÅÏÑ∏ Ï£ºÏÜå ÏûÖÎ†•">
                                                </label><br>
                                          
                                                <label>Ìú¥ÎåÄÌè∞ Î≤àÌò∏:
                                                  <select v-model="orderInfo.phonePrefix" class="order-input short" required>
                                                    <option value="010">010</option>
                                                    <option value="011">011</option>
                                                    <option value="016">016</option>
                                                    <option value="017">017</option>
                                                    <option value="018">018</option>
                                                    <option value="019">019</option>
                                                  </select> - 
                                                  <input type="text" class="order-input short"
                                                    v-model="orderInfo.phoneMiddle" maxlength="4" placeholder="1234" required> - 
                                                  <input type="text" class="order-input short" v-model="orderInfo.phoneSuffix" maxlength="4"
                                                    placeholder="5678" required>
                                                </label><br>
                                          
                                                <h3>Î∞∞ÏÜ° ÏöîÏ≤≠ ÏÇ¨Ìï≠</h3>
                                                <input type="text" class="order-input" v-model="orderInfo.customMessage" placeholder="Î∞∞ÏÜ° ÏöîÏ≤≠ÏÇ¨Ìï≠ ÏûÖÎ†•">
                                                <div>
                                                    <button @click="saveChanges(orderId)" class="order-button">Ï†ÄÏû•</button>
                                                    <button @click="cancelEdit" class="order-button">Ï∑®ÏÜå</button>
                                                </div>
                                            </div>

                                            <table class="order-history__details-table">
                                                <thead>
                                                    <tr>
                                                        <th>ÏÉÅÌíàÎ™Ö</th>
                                                        <th>ÏÉÅÌÉú</th>
                                                        <th>ÏàòÎüâ</th>
                                                        <th>Í∞ÄÍ≤©</th>
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr v-for="product in orders" :key="product.orderId">
                                                        <td>{{ product.productName }}</td>
                                                        <td v-if="product.refundStatus != 'none' && product.refundStatus == 'exchange'">ÍµêÌôòÏ†ëÏàò</td>
                                                        <td v-else-if="product.refundStatus != 'none' && product.refundStatus == 'exchanged'">ÍµêÌôòÏôÑÎ£å</td>
                                                        <td v-else-if="product.refundStatus != 'none' && product.refundStatus == 'return'">Î∞òÌíàÏ†ëÏàò</td>
                                                        <td v-else-if="product.refundStatus != 'none' && product.refundStatus == 'returned'">Î∞òÌíàÏôÑÎ£å</td>
                                                        <td v-else-if="product.refundStatus != 'none' && product.refundStatus == 'shipped'">Î∞∞ÏÜ°Ï§ë</td>
                                                        <td v-else-if="product.refundStatus != 'none' && product.refundStatus == 'delivered'">Î∞∞ÏÜ°ÏôÑÎ£å</td>
                                                        <td v-else-if="product.refundStatus == 'none' && product.orderStatus == 'paid'">Ï£ºÎ¨∏Ï†ëÏàò</td>
                                                        <td v-else-if="product.refundStatus == 'none' && product.orderStatus == 'cancel'">Ï£ºÎ¨∏Ï∑®ÏÜå</td>
                                                        <td v-else-if="product.refundStatus == 'none' && product.orderStatus == 'canceled'">ÌôòÎ∂àÏôÑÎ£å</td>
                                                        <td>{{ product.quantity }}</td>
                                                        <td>{{ formatPrice(Number(product.price)) }} Ïõê</td>
                                                        <td>
                                                            <button @click="fnAddCart(product)" :class="['add-to-cart-button', {'added-to-cart': isAddedToCart(product.productId)}]"><span class="material-symbols-outlined">add_shopping_cart</span></button>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <div v-if="cartMessage" class="cart-message">{{ cartMessage }}</div>
                                            <div v-if="determineShippingStatus(orders) == 'Ï£ºÎ¨∏Ï†ëÏàò'">
                                                <button @click="cancelOrder(orders,orderId)" class="order-button">Ï£ºÎ¨∏Ï∑®ÏÜå</button>
                                                <button @click="toggleEditMode(orders[0])" class="order-button">Î∞∞ÏÜ°Ï†ïÎ≥¥ÏàòÏ†ï</button>
                                            </div>
                                            <div v-if="hasDeliveredProduct(orders)">
                                                <button @click="openReturnPopup(orders)" class="order-button">ÍµêÌôò/Î∞òÌíàÏã†Ï≤≠</button>
                                            </div>
                                            <div>
                                                <p>‚ÄªÌï¥Îãπ Ï£ºÎ¨∏Í±¥Ïù¥ [Ï£ºÎ¨∏Ï†ëÏàò] ÏÉÅÌÉúÏùº ÎïåÎßå Ï£ºÎ¨∏Ï∑®ÏÜå, Î∞∞ÏÜ°Ï†ïÎ≥¥ÏàòÏ†ïÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.</p>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- ÍµêÌôò/Î∞òÌíà Ï†ëÏàò ÌåùÏóÖ -->
        <div class="exchange-return-popup-overlay" v-if="isPopupVisible">
            <div class="exchange-return-popup-container">
                <h2>ÍµêÌôò/Î∞òÌíà Ïã†Ï≤≠</h2>
                
                <div class="exchange-return-popup-scroll-area">
                    <label class="exchange-return-radio">
                        <input type="radio" v-model="isExchange" value="exchange"> ÍµêÌôò
                    </label>
                    <label class="exchange-return-radio">
                        <input type="radio" v-model="isExchange" value="return"> Î∞òÌíà
                    </label>
    
                    <h3>Ï£ºÎ¨∏ ÏÉÅÌíà ÏÑ†ÌÉù</h3>
                    <div v-for="item in selectedOrder" :key="item.orderDetailId" class="exchange-return-box">
                        <label :class="{'disabled-item': item.refundStatus != 'delivered'}">
                            <input type="checkbox" v-model="item.checked" :disabled="item.refundStatus != 'delivered'" @click="console.log(item)"> {{ item.productName }}
                        </label>
    
                        <div v-if="item.checked">
                            <label>ÏàòÎüâ ÏÑ†ÌÉù:
                                <select v-model="item.selectedQuantity">
                                    <option v-for="n in Array.from({ length: item.quantity }, (_, i) => i + 1)" :key="n" :value="n">{{ n }}</option>
                                </select>
                            </label>
                        </div>
                    </div>
    
                    <h3>{{ isExchange === 'exchange' ? 'ÍµêÌôò ÏÇ¨Ïú†' : 'Î∞òÌíà ÏÇ¨Ïú†' }}</h3>
                    <select v-model="reason" class="exchange-return-select">
                        <option value="">ÏÇ¨Ïú†Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî</option>
                        <option value="ÏÉÅÌíà Î∂àÎüâ">ÏÉÅÌíà Î∂àÎüâ</option>
                        <option value="Ïò§Î∞∞ÏÜ°">Ïò§Î∞∞ÏÜ°</option>
                        <option value="Îã®Ïàú Î≥ÄÏã¨">Îã®Ïàú Î≥ÄÏã¨</option>
                    </select>
                    
                    <h3>ÏÉÅÏÑ∏ ÏÇ¨Ïú†</h3>
                    <textarea v-model="detailedReason" placeholder="ÏÉÅÏÑ∏ ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" class="exchange-return-textarea"></textarea>
    
                    <div class="exchange-return-notice">
                        <p>‚Äª ÍµêÌôò/Î∞òÌíà Ïãú Î∞∞ÏÜ°ÎπÑÍ∞Ä Î∂ÄÍ≥ºÎê† Ïàò ÏûàÏäµÎãàÎã§.</p>
                        <p>‚Äª Ïã†Ï≤≠ Ï†ëÏàò ÌõÑ Í≥†Í∞ùÎãòÍªòÏÑú Î≥¥ÎÇ¥Ï£ºÏã† ÏÉÅÌíàÏùÄ Í≤ÄÏàòÍ≥ºÏ†ï(Ï£ºÎßê Ï†úÏô∏, ÏµúÎåÄ 5Ïùº)ÏùÑ Í±∞Ï≥ê Í≤∞Ï†ú Ï∑®ÏÜå ÏöîÏ≤≠Ïù¥ ÏßÑÌñâÎê©ÎãàÎã§.</p> 
                        <p>‚Äª ÏÉÅÌíàÏùò ÏÉÅÌÉú Î∞è ÏöîÏ≤≠ ÎÇ¥Ïö©Ïóê Îî∞Îùº ÍµêÌôò/Î∞òÌíàÏù¥ Î∂àÍ∞ÄÎä•Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                    </div>
    
                    <label class="exchange-return-agreement">
                        <input type="checkbox" v-model="isAgreed" @click="toggleAgreement"> ÏúÑ ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌïòÏòÄÏúºÎ©∞, ÍµêÌôò/Î∞òÌíà ÏöîÏ≤≠Ïóê ÎèôÏùòÌï©ÎãàÎã§.
                    </label>
                </div>
    
                <button @click="submitRequest" :disabled="!isAgreed" class="exchange-return-submit">Ï†ëÏàòÌïòÍ∏∞</button>
                <button @click="closePopup" class="exchange-return-close">Îã´Í∏∞</button>
            </div>
        </div>


    </div>
    <!-- app Ï¢ÖÎ£å -->


	<jsp:include page="/WEB-INF/common/footer.jsp"/>

    
</body>
</html>
<script>
    
    document.addEventListener("DOMContentLoaded", function () {
        const app = Vue.createApp({
            data() {
                return {
                    sessionId:"${sessionId}",
                    focusOrderId:"${map.orderId}",
                    userInfo:{},
                    orderList: [],
                    startDate: "",
                    endDate: "",
                    selectedStatus: 'all',
                    ordersByDate:{},
                    addedToCart:[],
                    cartMessage: "",
                    isFading: false,
                    timeoutMap: {},
                    messageTimeout: null,
                    editOrderInfoFlg : false,
                    isEditing: false,
                    orderInfo: {
                        receiver: "", 
                        zipcode: "", 
                        baseAddress: "", 
                        detailAddress: "", 
                        phonePrefix: "010", 
                        phoneMiddle: "", 
                        phoneSuffix: "", 
                        customMessage: ""
                    },
                    isPopupVisible: false,
                    selectedOrder: null,
                    isExchange: "exchange",
                    selectedQuantity:"",
                    reason: "",
                    detailedReason:"",
                    isAgreed: false,
                };
            },
            computed: {
                groupedOrders() {
                    const groupedByDate = this.orderList
                        .map(order => {
                            let orderDate = new Date(order.orderedAt).toLocaleDateString('ko-KR', { 
                                year: 'numeric', 
                                month: '2-digit', 
                                day: '2-digit' 
                            }).replace(/\. /g, '-').replace('.', '');
                            // console.log("Ï£ºÎ¨∏ ÎÇ†Ïßú Î≥ÄÌôò: ",order.orderedAt, "‚Üí", orderDate);

                            return { ...order, formattedDate: orderDate };
                        })
                        .filter(order => {
                            // console.log("ÌïÑÌÑ∞ÎßÅ: ",order.formattedDate, ">=", this.startDate, "&&", order.formattedDate, "<=", this.endDate);
                            return order.formattedDate >= this.startDate && order.formattedDate <= this.endDate;
                        })
                        .reduce((groups, order) => {
                            if (!groups[order.formattedDate]) {
                                groups[order.formattedDate] = {};
                            }
                            if (!groups[order.formattedDate][order.orderId]) {
                                groups[order.formattedDate][order.orderId] = [];
                            }
                            groups[order.formattedDate][order.orderId].push(order);
                            return groups;
                        }, {});

                        console.log("üìå ÎÇ†Ïßú Î∞è Ï£ºÎ¨∏Î≤àÌò∏Î≥ÑÎ°ú Í∑∏Î£πÌôîÎêú Îç∞Ïù¥ÌÑ∞:",groupedByDate);
                    return groupedByDate;
                },isEmptyOrderList() {
                    return Object.keys(this.groupedOrders).length === 0;
                },
                determineShippingStatus() {
                    return (orderItems) => {
                        const statuses = orderItems.map(item => item.refundStatus);
                        const orderStatus = orderItems[0].orderStatus;

                        if (orderStatus === 'cancel') return 'Ï£ºÎ¨∏Ï∑®ÏÜå';
                        if (orderStatus === 'canceled') return 'ÌôòÎ∂àÏôÑÎ£å';

                        if (statuses.every(status => status === 'none')) return 'Ï£ºÎ¨∏Ï†ëÏàò';
                        if (statuses.every(status => status === 'shipped')) return 'Î∞∞ÏÜ°Ï§ë';
                        if (statuses.every(status => status === 'delivered')) return 'Î∞∞ÏÜ°ÏôÑÎ£å';
                        if (statuses.some(status => status === 'exchange')) return 'ÍµêÌôòÏã†Ï≤≠';
                        if (statuses.every(status => status === 'exchanged')) return 'ÍµêÌôòÏôÑÎ£å';
                        if (statuses.some(status => status === 'return')) return 'Î∞òÌíàÏã†Ï≤≠';
                        if (statuses.every(status => status === 'returned')) return 'Î∞òÌíàÏôÑÎ£å';

                        return 'Ï£ºÎ¨∏Ï†ëÏàò';
                    };
                }
            },
            watch: {
                groupedOrders: {
                    handler(newVal) {
                        this.ordersByDate = newVal ? JSON.parse(JSON.stringify(newVal)) : {};  // data ÏÜçÏÑ±ÏúºÎ°ú Î∞òÏòÅ
                    },
                    deep: true,
                    immediate: true
                },
                orderList(newList) {
                    if (this.focusOrderId && newList.length > 0) {
                        this.$nextTick(() => {
                            this.scrollToOrder(this.focusOrderId);
                        });
                    }
                }
            },
            methods: {
                setDateRange(period) {
                    let today = new Date();
                    let startDate = new Date();
                    
                    startDate.setMonth(today.getMonth() - period);

                    this.startDate = this.formatDate(startDate);
                    this.endDate = this.formatDate(today);

                    console.log(this.startDate,this.endDate);

                    this.fnOrderList();
                },
                fnUserInfo() {
                    let self = this;
                    let params = { userId: self.sessionId };
                    $.ajax({
                        url: "/user/info.dox",
                        dataType: "json",
                        type: "POST",
                        data: params,
                        success: function (data) {
                            self.userInfo = data.user;
                            self.setDateRange(1);
                        }
                    });
                },
                fnOrderList:function(orderId){
                    let self = this;
                    let refundStatuses;
                    let orderStatuses;
                    
                    if (self.selectedStatus === 'exchange_return') {
                        refundStatuses = ['exchange', 'exchanged', 'return', 'returned'];
                    } else if (self.selectedStatus === 'shipped' || self.selectedStatus === 'delivered') {
                        refundStatuses = [self.selectedStatus];
                    } else if (self.selectedStatus === 'canceled') {
                        orderStatuses = ['cancel', 'canceled'];
                    } else if (self.selectedStatus === 'paid') {
                        orderStatuses = ['paid'];
                        refundStatuses = ['none'];
                    }

                    let params = {
                        userId: self.userInfo.userId, 
                        startDate : self.startDate,
                        endDate : self.endDate,
                    };

                    if(refundStatuses != null){
                        params.refundStatuses = JSON.stringify(refundStatuses);
                    }
                    if (orderStatuses != null){
                        params.orderStatuses = JSON.stringify(orderStatuses);
                    }

                    console.log("fnOrderList >>>>> ",params);

                    $.ajax({
                        url: "/order/AllList.dox",
                        dataType: "json",
                        type: "POST",
                        data: params,
                        success: function (data) {
                            console.log("Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Î™©Î°ù >>> ",data.orderList);
                            self.orderList = data.orderList.map(order => ({
                                ...order,
                                showDetails: false
                            }));
                        }
                    });
                },
                toggleEditMode(order) {
                    console.log("Î∞∞ÏÜ°Ï†ïÎ≥¥ÏàòÏ†ï Ï†ïÎ≥¥>>> ",order);
                    const fullAddress = order.receiverAddr; 
                    console.log("Î∞∞ÏÜ°ÏßÄ Ï†ïÎ≥¥>>> ",order.receiverAddr);

                    const addressParts = fullAddress.split(", ");
                    const zipcode = addressParts.pop().trim();
                    const remainingAddress = addressParts.join(", ").trim(); 
                    const lastCommaIndex = remainingAddress.indexOf(", ");
                    let baseAddress = remainingAddress;
                    let detailAddress = "";

                    if (lastCommaIndex !== -1) {
                        baseAddress = remainingAddress.substring(0, lastCommaIndex).trim();
                        detailAddress = remainingAddress.substring(lastCommaIndex + 2).trim();
                    }

                    this.orderInfo.receiver = order.receiverName;
                    this.orderInfo.zipcode = zipcode;
                    this.orderInfo.baseAddress = baseAddress;
                    this.orderInfo.detailAddress = detailAddress;

                    function formatPhoneNumber(phoneNumber) {
                        if (!phoneNumber || phoneNumber.length < 10) return ["010", "", ""];

                        const prefix = phoneNumber.substring(0, 3);
                        let middle = "";
                        let suffix = "";

                        if (phoneNumber.length === 11) {
                            middle = phoneNumber.substring(3, 7);
                            suffix = phoneNumber.substring(7);
                        } else if (phoneNumber.length === 10) {
                            middle = phoneNumber.substring(3, 6);
                            suffix = phoneNumber.substring(6);
                        }

                        return [prefix, middle, suffix];
                    }

                    const [phonePrefix, phoneMiddle, phoneSuffix] = formatPhoneNumber(order.receiverPhone);
                    
                    this.orderInfo.phonePrefix = phonePrefix;
                    this.orderInfo.phoneMiddle = phoneMiddle;
                    this.orderInfo.phoneSuffix = phoneSuffix;

                    this.orderInfo.customMessage = order.deliveryMessage;
                    this.isEditing = true;
                },
                searchAddress() {
                    let self = this;

                    new daum.Postcode({
                        oncomplete: function (data) {
                            self.orderInfo.zipcode = data.zonecode;
                            self.orderInfo.baseAddress = data.address;
                            self.orderInfo.detailAddress = "";
                        }
                    }).open();
                },
                saveChanges(orderId) {
                    let self = this;

                    if (!self.orderInfo.receiver) {
                        alert("ÏàòÎ†πÏù∏ ÏÑ±Ìï®ÏùÑ Ï†ïÌôïÌûà ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }
                    if (!self.orderInfo.baseAddress || !self.orderInfo.zipcode) {
                        alert("Î∞∞ÏÜ°Î∞õÏùÑ Ï£ºÏÜåÎ•º Ï†ïÌôïÌûà ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }
                    if (!self.orderInfo.phoneMiddle || !self.orderInfo.phoneSuffix) {
                        alert("Ìú¥ÎåÄÌè∞ Î≤àÌò∏Î•º Ï†ïÌôïÌûà ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }

                    let receiverPhone = self.orderInfo.phonePrefix + self.orderInfo.phoneMiddle + self.orderInfo.phoneSuffix;
                    console.log(receiverPhone);
                    let receiverAddr = self.orderInfo.baseAddress + ", " + self.orderInfo.detailAddress + ", " + self.orderInfo.zipcode;
                    console.log(receiverAddr);
                    
                    let params = {
                        userId: self.userInfo.userId, 
                        orderId : orderId,
                        receiverName : self.orderInfo.receiver,
                        receiverPhone : receiverPhone,
                        receiverAddr : receiverAddr,
                        deliveryMessage: self.orderInfo.customMessage
                    };
                    $.ajax({
                        url: "/order/editInfo.dox",
                        type: "POST",
                        data: params,
                        dataType: "json",
                        success: function (data) {
                            console.log(data);
                            alert("Ï£ºÎ¨∏/Î∞∞ÏÜ° Ï†ïÎ≥¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.");
                            self.isEditing = false;
                            self.fnOrderList(orderId);
                        }
                    });

                },
                cancelEdit() {
                    this.isEditing = false;
                },
                formatPhoneNumber(phoneNumber) {
                    if (!phoneNumber || phoneNumber.length < 10) return phoneNumber;

                    const prefix = phoneNumber.substring(0, 3);
                    let middle = "";
                    let suffix = "";

                    if (phoneNumber.length === 11) {
                        middle = phoneNumber.substring(3, 7);
                        suffix = phoneNumber.substring(7);
                    } else if (phoneNumber.length === 10) {
                        middle = phoneNumber.substring(3, 6);
                        suffix = phoneNumber.substring(6);
                    } else {
                        return phoneNumber;
                    }

                    return prefix + "-" + middle + "-" + suffix;
                },
                formatPrice(value) {
                    if (isNaN(value) || value === null) return "0";
                    return value.toLocaleString("ko-KR");
                },
                formatDate(date) {
                    let year = date.getFullYear();
                    let month = ('0' + (date.getMonth() + 1)).slice(-2);
                    let day = ('0' + date.getDate()).slice(-2);
                    return year + "-" + month + "-" + day;
                },
                cancelOrder(orders,orderId) {
                    let self = this;
                    console.log("Ï∑®ÏÜåÌï† Ï£ºÎ¨∏ Î≤àÌò∏ >>> ",orderId, "/// Ï£ºÎ¨∏Î™©Î°ù >>> ",orders);

                    const invalidStatuses = ['shipped', 'delivered', 'exchange', 'exchanged', 'return', 'returned'];
                    const hasInvalidStatus = orders.some(order =>
                        invalidStatuses.includes(order.refundStatus)
                    );

                    if (hasInvalidStatus) {
                        alert("Î∞∞ÏÜ°Ïù¥ ÏãúÏûëÎêú ÏÉÅÌíà ÎòêÎäî ÍµêÌôò/Î∞òÌíà Ï§ëÏù∏ ÏÉÅÌíàÏù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏñ¥ Ï£ºÎ¨∏ÏùÑ Ï∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
                        return;
                    }
                    
                    if(confirm("Ï†ïÎßê Ìï¥Îãπ Ï£ºÎ¨∏ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?")){
                        let params = {
                            userId: self.userInfo.userId, 
                            orderId : orderId,
                            orderStatus : "cancel"
                        };
                        $.ajax({
                            url: "/order/status.dox",
                            type: "POST",
                            data: params,
                            dataType: "json",
                            success: function (data) {
                                console.log(data);
                                alert("Ï£ºÎ¨∏Ïù¥ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.");
                                self.fnOrderList();
                            }
                        });
                    }
                },
                toggleDetails(orderIdToToggle) {
                    for (let date in this.ordersByDate) {
                        for (let orderId in this.ordersByDate[date]) {
                            this.ordersByDate[date][orderId].forEach(order => {
                                // Í∞Å Ï£ºÎ¨∏Ïóê ÎåÄÌï¥ÏÑúÎßå showDetailsÎ•º ÌÜ†Í∏Ä
                                if (order.orderId === orderIdToToggle) {
                                    order.showDetails = !order.showDetails;
                                    this.isEditing = false;
                                    console.log("Ï£ºÎ¨∏Î≤àÌò∏: ",orderIdToToggle,"Ïùò showDetails: ",order.showDetails);
                                } else {
                                    this.isEditing = false;
                                    order.showDetails = false;  // Îã§Î•∏ Ï£ºÎ¨∏Ïùò showDetailsÎäî falseÎ°ú ÏÑ§Ï†ï
                                }
                            });
                        }
                    }
                    console.log(this.ordersByDate);
                },
                fnAddCart:function(product){
                    let self = this;
                    console.log("Ïû•Î∞îÍµ¨ÎãàÏóê Îã¥ÏùÑ ÏÉÅÌíà Ï†ïÎ≥¥ >>> ",product);
                    let params = {
                        sessionId:self.sessionId,
                        userId: self.userInfo.userId, 
                        productId : product.productId,
                        quantity : 1,
                        option: "",
                        checkYn : "N"
                    };
                    $.ajax({
                        url: "/cart/addProduct.dox",
                        type: "POST",
                        data: params,
                        dataType: "json",
                        success: function (data) {
                            console.log(data);
                            if (!self.addedToCart.includes(product.productId)) {
                                self.addedToCart.push(product.productId);
                            }

                            if (self.messageTimeout) {
                                clearTimeout(self.messageTimeout);
                            }

                            self.isFading = false;
                            self.cartMessage = product.productName+" ÏÉÅÌíàÏù¥ Ïû•Î∞îÍµ¨ÎãàÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!";
                            
                            self.messageTimeout = setTimeout(() => {
                                self.cartMessage = "";
                                setTimeout(() => {
                                    self.cartMessage = "";
                                    self.isFading = false;
                                }, 500);
                            }, 2000);

                            if (self.timeoutMap[product.productId]) {
                                clearTimeout(self.timeoutMap[product.productId]);
                            }

                            self.timeoutMap[product.productId] = setTimeout(() => {
                                self.addedToCart = self.addedToCart.filter(id => id !== product.productId);
                            }, 2000);
                        }
                    });
                },
                isAddedToCart(productId) {
                    return this.addedToCart.includes(productId);
                },
                openReturnPopup(order) {
                    console.log("Ï£ºÎ¨∏ Ï†ïÎ≥¥ >>> ",order);
                    this.selectedOrder = order.map(item => ({
                        ...item,
                        checked: false,
                        selectedQuantity: 1
                    }));
                    console.log("Ï£ºÎ¨∏ >>> ",this.selectedOrder);
                    this.isPopupVisible = true;
                },
                closePopup() {
                    this.isPopupVisible = false;
                },
                toggleAgreement() {
                    this.isAgreed = !this.isAgreed;
                },
                submitRequest() {
                    let self = this;

                    const selectedItems = self.selectedOrder
                        .filter(item => item.checked && item.refundStatus === 'delivered')
                        .map(item => ({
                        orderDetailId: item.orderDetailId,
                        quantity: item.selectedQuantity,
                        price:(item.price/item.quantity)*item.selectedQuantity
                    }));
                    
                    console.log(selectedItems);

                    if (selectedItems.length === 0) {
                        alert("ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }
                    if (!self.reason) {
                        alert("ÍµêÌôò/Î∞òÌíà ÏÇ¨Ïú†Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }
                    if (!self.detailedReason) {
                        alert("ÏÉÅÏÑ∏ ÏÇ¨Ïú†Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.");
                        return;
                    }
                    
                    let refundStatus = self.isExchange === "exchange" ? "exchange" : "return";

                    console.log("ÍµêÌôò/Î∞òÌíà Ïã†Ï≤≠ Îç∞Ïù¥ÌÑ∞:", {
                        orderId : self.selectedOrder[0].orderId,
                        selectedItems : JSON.stringify(selectedItems),
                        reason: self.reason,
                        reasonDetail: self.detailedReason,
                        refundStatus : refundStatus,
                    });

                    let params = {
                        orderId : self.selectedOrder[0].orderId,
                        selectedItems : JSON.stringify(selectedItems),
                        reason: self.reason,
                        reasonDetail: self.detailedReason,
                        refundStatus : refundStatus
                    };
                    $.ajax({
                        url: "/order/refund.dox",
                        type: "POST",
                        data: params,
                        dataType: "json",
                        success: function (data) {
                            console.log("ÍµêÌôò/Î∞òÌíà Ï†ëÏàò ÏÉÅÌÉú >>> ",data);
                            if(data.result == "success"){
                                alert("ÍµêÌôò/Î∞òÌíà Ïã†Ï≤≠Ïù¥ Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§.");
                                self.isPopupVisible = false;
                                self.fnOrderList();
                            }
                        }
                    });
                },
                scrollToOrder(orderId) {
                    console.log("üîç scrollToOrder Ïã§ÌñâÎê®. orderId:", orderId);
                    const target = document.getElementById('order-' + orderId);
                    console.log("üéØ Ï∞æÏùÄ DOM ÏóòÎ¶¨Î®ºÌä∏:", target);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        target.classList.add('highlight-order');
                        setTimeout(() => target.classList.remove('highlight-order'), 2000);
                    } else {
                        console.warn("‚ö†Ô∏è Ìï¥Îãπ orderIdÎ•º Í∞ÄÏßÑ ÏöîÏÜåÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
                    }
                },
                hasDeliveredProduct(orders) {
                    return orders.some(item => item.refundStatus === 'delivered');
                },
            },
            mounted() {
                this.fnUserInfo();

                let orderId = this.focusOrderId;
                console.log("‚úÖ ÎÑòÏñ¥Ïò® orderId:", orderId);
                if (orderId) {
                    this.$nextTick(() => {
                        this.scrollToOrder(orderId);
                    });
                }
                
            }
        });

        app.mount("#app");
    });
</script>